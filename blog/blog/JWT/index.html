<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.64">
    <title>JWT | Vuepress Theme Blue</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-0b99fa56.css" as="style"><link rel="stylesheet" href="/assets/style-0b99fa56.css">
    <link rel="modulepreload" href="/assets/app-a6a5d4a7.js"><link rel="modulepreload" href="/assets/index.html-d3d05473.js"><link rel="modulepreload" href="/assets/index.html-0a493daa.js"><link rel="prefetch" href="/assets/404.html-30afe3c5.js" as="script"><link rel="prefetch" href="/assets/index.html-87180724.js" as="script"><link rel="prefetch" href="/assets/index.html-ed0fd3d1.js" as="script"><link rel="prefetch" href="/assets/index.html-817918d0.js" as="script"><link rel="prefetch" href="/assets/index.html-ab2771d8.js" as="script"><link rel="prefetch" href="/assets/index.html-62bdddc1.js" as="script"><link rel="prefetch" href="/assets/index.html-0aaea317.js" as="script"><link rel="prefetch" href="/assets/index.html-362e5eda.js" as="script"><link rel="prefetch" href="/assets/index.html-22e9a1e5.js" as="script"><link rel="prefetch" href="/assets/index.html-03899184.js" as="script"><link rel="prefetch" href="/assets/index.html-bd04de7d.js" as="script"><link rel="prefetch" href="/assets/index.html-8432d7c2.js" as="script"><link rel="prefetch" href="/assets/index.html-f4bc7919.js" as="script"><link rel="prefetch" href="/assets/index.html-266cfb01.js" as="script"><link rel="prefetch" href="/assets/index.html-b2cc8270.js" as="script"><link rel="prefetch" href="/assets/index.html-98c00800.js" as="script"><link rel="prefetch" href="/assets/index.html-ae33ec0f.js" as="script"><link rel="prefetch" href="/assets/index.html-9f76b2fb.js" as="script"><link rel="prefetch" href="/assets/index.html-a8dc90b6.js" as="script"><link rel="prefetch" href="/assets/index.html-3d3599dc.js" as="script"><link rel="prefetch" href="/assets/index.html-23399167.js" as="script"><link rel="prefetch" href="/assets/index.html-404c3b2e.js" as="script"><link rel="prefetch" href="/assets/index.html-a9560cb8.js" as="script"><link rel="prefetch" href="/assets/index.html-cdee76d8.js" as="script"><link rel="prefetch" href="/assets/index.html-0e1d1c06.js" as="script"><link rel="prefetch" href="/assets/index.html-f692a8a6.js" as="script"><link rel="prefetch" href="/assets/index.html-b5f11fde.js" as="script"><link rel="prefetch" href="/assets/index.html-bb530bb0.js" as="script"><link rel="prefetch" href="/assets/index.html-0c076014.js" as="script"><link rel="prefetch" href="/assets/index.html-e965da56.js" as="script"><link rel="prefetch" href="/assets/index.html-d03c30ac.js" as="script"><link rel="prefetch" href="/assets/index.html-3f6e11fd.js" as="script"><link rel="prefetch" href="/assets/index.html-718a010f.js" as="script"><link rel="prefetch" href="/assets/index.html-b53b6fcb.js" as="script"><link rel="prefetch" href="/assets/index.html-023f9a25.js" as="script"><link rel="prefetch" href="/assets/index.html-52791d54.js" as="script"><link rel="prefetch" href="/assets/index.html-782e61bb.js" as="script"><link rel="prefetch" href="/assets/index.html-98c2c35b.js" as="script"><link rel="prefetch" href="/assets/index.html-fabfc81c.js" as="script"><link rel="prefetch" href="/assets/index.html-8fb78894.js" as="script"><link rel="prefetch" href="/assets/index.html-620675de.js" as="script"><link rel="prefetch" href="/assets/index.html-b7cf35a2.js" as="script"><link rel="prefetch" href="/assets/index.html-e14ec4b7.js" as="script"><link rel="prefetch" href="/assets/index.html-d9618c98.js" as="script"><link rel="prefetch" href="/assets/index.html-295b3ade.js" as="script"><link rel="prefetch" href="/assets/index.html-3da56c89.js" as="script"><link rel="prefetch" href="/assets/index.html-ea362abf.js" as="script"><link rel="prefetch" href="/assets/index.html-f5f5632b.js" as="script"><link rel="prefetch" href="/assets/index.html-df93660b.js" as="script"><link rel="prefetch" href="/assets/index.html-164449d6.js" as="script"><link rel="prefetch" href="/assets/index.html-4b594f0f.js" as="script"><link rel="prefetch" href="/assets/index.html-3ff531d7.js" as="script"><link rel="prefetch" href="/assets/404.html-99967f39.js" as="script"><link rel="prefetch" href="/assets/index.html-02bedc7d.js" as="script"><link rel="prefetch" href="/assets/index.html-32ba965a.js" as="script"><link rel="prefetch" href="/assets/index.html-8d2845c0.js" as="script"><link rel="prefetch" href="/assets/index.html-7e3b40a2.js" as="script"><link rel="prefetch" href="/assets/index.html-5e14943c.js" as="script"><link rel="prefetch" href="/assets/index.html-8ddd90f6.js" as="script"><link rel="prefetch" href="/assets/index.html-199bc0b0.js" as="script"><link rel="prefetch" href="/assets/index.html-f8b17ccb.js" as="script"><link rel="prefetch" href="/assets/index.html-1ff18482.js" as="script"><link rel="prefetch" href="/assets/index.html-731a621f.js" as="script"><link rel="prefetch" href="/assets/index.html-cb2cf034.js" as="script"><link rel="prefetch" href="/assets/index.html-ffdd0bf6.js" as="script"><link rel="prefetch" href="/assets/index.html-42d4917e.js" as="script"><link rel="prefetch" href="/assets/index.html-9a0a97b3.js" as="script"><link rel="prefetch" href="/assets/index.html-81eaf5de.js" as="script"><link rel="prefetch" href="/assets/index.html-ebb9ee77.js" as="script"><link rel="prefetch" href="/assets/index.html-23c0d38b.js" as="script"><link rel="prefetch" href="/assets/index.html-816f6ec1.js" as="script"><link rel="prefetch" href="/assets/index.html-e9073f0e.js" as="script"><link rel="prefetch" href="/assets/index.html-e96cc586.js" as="script"><link rel="prefetch" href="/assets/index.html-a6758ea4.js" as="script"><link rel="prefetch" href="/assets/index.html-8cc81fbf.js" as="script"><link rel="prefetch" href="/assets/index.html-6170b0bf.js" as="script"><link rel="prefetch" href="/assets/index.html-30911cd4.js" as="script"><link rel="prefetch" href="/assets/index.html-33b21e52.js" as="script"><link rel="prefetch" href="/assets/index.html-5e65c1b9.js" as="script"><link rel="prefetch" href="/assets/index.html-2a164f81.js" as="script"><link rel="prefetch" href="/assets/index.html-2147f896.js" as="script"><link rel="prefetch" href="/assets/index.html-11385ea4.js" as="script"><link rel="prefetch" href="/assets/index.html-e02a98c4.js" as="script"><link rel="prefetch" href="/assets/index.html-e7298fb0.js" as="script"><link rel="prefetch" href="/assets/index.html-ef1df29b.js" as="script"><link rel="prefetch" href="/assets/index.html-82ec9c97.js" as="script"><link rel="prefetch" href="/assets/index.html-51dc7c9c.js" as="script"><link rel="prefetch" href="/assets/index.html-f8e6c09a.js" as="script"><link rel="prefetch" href="/assets/index.html-d7237f1b.js" as="script"><link rel="prefetch" href="/assets/index.html-264956b9.js" as="script"><link rel="prefetch" href="/assets/index.html-c0aca1d1.js" as="script"><link rel="prefetch" href="/assets/index.html-77117f6a.js" as="script"><link rel="prefetch" href="/assets/index.html-ece5da38.js" as="script"><link rel="prefetch" href="/assets/index.html-00db6cca.js" as="script"><link rel="prefetch" href="/assets/index.html-fd95335e.js" as="script"><link rel="prefetch" href="/assets/index.html-14649045.js" as="script"><link rel="prefetch" href="/assets/index.html-6546a4e6.js" as="script"><link rel="prefetch" href="/assets/index.html-9b4e410e.js" as="script"><link rel="prefetch" href="/assets/index.html-9aa4d534.js" as="script"><link rel="prefetch" href="/assets/index.html-05b76199.js" as="script"><link rel="prefetch" href="/assets/index.html-66c19831.js" as="script"><link rel="prefetch" href="/assets/index.html-3caeb87d.js" as="script"><link rel="prefetch" href="/assets/index.html-9d0d9115.js" as="script"><link rel="prefetch" href="/assets/index.html-ad57ae51.js" as="script"><link rel="prefetch" href="/assets/giscus-2a044aea-497f0bd4.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><div class="nav" data-v-a231a75e data-v-ad3cbd41><div class="container" data-v-ad3cbd41><!--[--><a href="/" class="nav-action-wrapper" data-v-ad3cbd41><div class="nav-action" data-v-ad3cbd41>首页</div></a><a href="/category" class="nav-action-wrapper" data-v-ad3cbd41><div class="nav-action" data-v-ad3cbd41>分类</div></a><!--]--></div></div><div class="container" data-v-a231a75e><!--[--><div class="blog-page" data-v-dd29a953><div class="card blog" data-v-dd29a953 data-v-2e70653c><!--[--><!----><h1 class="title" data-v-dd29a953>JWT</h1><div class="markdown-body content" data-v-dd29a953><h2 id="jwt" tabindex="-1"><a class="header-anchor" href="#jwt" aria-hidden="true">#</a> JWT</h2><p>互联网服务离不开用户认证</p><h3 id="_1-session认证" tabindex="-1"><a class="header-anchor" href="#_1-session认证" aria-hidden="true">#</a> 1. session认证</h3><ol><li>用户发送用户名和密码向服务器发送登录请求</li><li>服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间、过期时间等等</li><li>服务器生成session_id作为key，val为用户id等身份数据，然后向用户返回一个 session_id，写入用户的 cookie</li><li>用户随后的每次请求，都会通过 cookie，将 session_id 传回服务器</li><li>服务器收到 session_id，使用session_id查询用户身份数据，由此得知用户的身份</li></ol><p>这种方式的好处是session可控制，缺点是扩展性差、占用内存/存储空间，跨域等问题</p><h3 id="_2-jwt的原理" tabindex="-1"><a class="header-anchor" href="#_2-jwt的原理" aria-hidden="true">#</a> 2. JWT的原理</h3><p>服务器不保存 session 数据，所有数据都保存在客户端，每次请求发回服务器，这就是jwt的原理，但是直接发送是不安全的，所以进行了加密，这就是JWT。</p><p>JWT全称 JSON Web Token，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;姓名&quot;</span><span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;角色&quot;</span><span class="token operator">:</span> <span class="token string">&quot;管理员&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;到期时间&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022年7月8日0点0分&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用户之后的每次请求通信，都要带上这个JSON对象，服务器只靠这个对象认定用户身份，为了防止用户篡改数据，服务器在生成这个对象的时候会进行加密和签名</p><h3 id="_3-jwt的数据结构" tabindex="-1"><a class="header-anchor" href="#_3-jwt的数据结构" aria-hidden="true">#</a> 3. JWT的数据结构</h3><p>实际的JWT大概长这样：<code>Header.Payload.Signature</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>Header 头部：</li><li>Payload 负载：</li><li>Signature 签名：</li></ul><h4 id="_3-1-header-头部" tabindex="-1"><a class="header-anchor" href="#_3-1-header-头部" aria-hidden="true">#</a> 3.1 Header 头部</h4><p>Header 部分是一个 JSON对象，描述 JWT 的元数据，通常是下面的样子：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>alg</code> 属性表示签名的算法，默认是 HMAC SHA256；</li><li><code>typ</code> 表示令牌的类型，JWT令牌统一写为 JWT</li></ul><h4 id="_3-2-payload-负载" tabindex="-1"><a class="header-anchor" href="#_3-2-payload-负载" aria-hidden="true">#</a> 3.2 Payload 负载</h4><p>Payload 也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段供选用</p><ul><li>iss (issuer)：签发人</li><li>exp (expiration time)：过期时间</li><li>sub (subject)：主题</li><li>aud (audience)：受众</li><li>nbf (Not Before)：生效时间</li><li>iat (Issued At)：签发时间</li><li>jti (JWT ID)：编号</li></ul><p>我们的用户信息也在这个部分进行定义：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234567890&quot;</span><span class="token punctuation">,</span>
  	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mittacy Chen&quot;</span><span class="token punctuation">,</span>
  	<span class="token property">&quot;role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;admin&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。</p><h4 id="_3-3-signature-签名" tabindex="-1"><a class="header-anchor" href="#_3-3-signature-签名" aria-hidden="true">#</a> 3.3 Signature 签名</h4><p>signature 部分是对前两部分的签名，防止数据篡改</p><p>首先，需要指定一个 <strong>密钥 secret</strong>，这个密钥只有服务器才只知道，不能泄露给用户。</p><p>然后使用 Header 里面指定的签名算法（默认是 HMAC SHA256）产生签名：</p><p><code>HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret)</code></p><p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，就可以返回给用户</p><h4 id="_3-4-base64url" tabindex="-1"><a class="header-anchor" href="#_3-4-base64url" aria-hidden="true">#</a> 3.4 Base64URL</h4><p>前面提到，Header 和 Payload 串型化的算法是 Base64URL，这个算法跟 Base64 算法的差异为：base64有三个字符 <code>+</code>、<code>/</code>、<code>=</code> 在URL里面有特殊含义，所以要被替换掉：<code>=被省略</code>、<code>+被替换成-</code>、<code>/被替换成_</code></p><h3 id="_4-jwt-的使用方式" tabindex="-1"><a class="header-anchor" href="#_4-jwt-的使用方式" aria-hidden="true">#</a> 4. JWT 的使用方式</h3><p>客户端收到服务器返回的 JWT后，客户端每次与服务器通信，都要带上这个 JWT。</p><ul><li>可以存储在Cookie里面，这种方式不支持跨域</li><li>存储在localStorage，发送时放在 HTTP 请求的头信息 <code>Authorization</code> 字段</li></ul><h3 id="_5-jwt的几个特点" tabindex="-1"><a class="header-anchor" href="#_5-jwt的几个特点" aria-hidden="true">#</a> 5. JWT的几个特点</h3><ul><li><p>JWT不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数</p></li><li><p>JWT的最大缺点是，由于服务器不保存session状态，因此无法再使用过程中废止某个token，或者更改token的权限，一旦JWT签发了，在到期之前就会始终有效。可以使用redis记录黑名单token，有效期就截止该token的有效期，在解析token前先查询黑名单是否存在，存在则无效，这种做法可以解决退出后让token失效，但是有一种情况是没法解决的：</p><blockquote><p>一个用户在手机A中登录了，然后又在手机B中登录，在过期之前手机A和B都可以登录，无法做到B登录后让A过期，如果要做到这点，就必须让服务器维护一个清单（记录该账号是否已经签发token），这样又回到session的老路了</p></blockquote></li><li><p>JWT本身包含了认证信息，一旦泄露，任何人都可以使用该令牌的所有权限，为了减少盗用，JWT的有效期应该设置得短一些，可以采用续签的方式，在校验token快过期时重新签发；同时 JWT 应该使用 HTTPS 协议传输</p></li></ul><h2 id="go实现用户身份校验" tabindex="-1"><a class="header-anchor" href="#go实现用户身份校验" aria-hidden="true">#</a> Go实现用户身份校验</h2><h3 id="_1-登录" tabindex="-1"><a class="header-anchor" href="#_1-登录" aria-hidden="true">#</a> 1. 登录</h3><p>JWT服务：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 生成管理员登录token</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ctl <span class="token operator">*</span>jwtService<span class="token punctuation">)</span> <span class="token function">GenerateAdminToken</span><span class="token punctuation">(</span>id <span class="token builtin">int64</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> role model<span class="token punctuation">.</span>UserRole<span class="token punctuation">,</span> expire time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	expireAt <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>expire<span class="token punctuation">)</span>
	token <span class="token operator">:=</span> model<span class="token punctuation">.</span>Token<span class="token punctuation">{</span>
		ID<span class="token punctuation">:</span>       id<span class="token punctuation">,</span>
		UserName<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
		Role<span class="token punctuation">:</span>     role<span class="token punctuation">,</span>
		RegisteredClaims<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span>RegisteredClaims<span class="token punctuation">{</span>
			ExpiresAt<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span><span class="token function">NewNumericDate</span><span class="token punctuation">(</span>expireAt<span class="token punctuation">)</span><span class="token punctuation">,</span>
			Issuer<span class="token punctuation">:</span>    viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;TOKEN_ISSUER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	t <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">,</span> token<span class="token punctuation">)</span>
	secret <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;TOKEN_SECRET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	tokenStr<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithStack</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> tokenStr<span class="token punctuation">,</span> expireAt<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解析token信息</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ctl <span class="token operator">*</span>jwtService<span class="token punctuation">)</span> <span class="token function">ParseToken</span><span class="token punctuation">(</span>tokenStr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Token<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	secret <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;TOKEN_SECRET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>tokenStr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>Token<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> secret<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>Valid <span class="token punctuation">{</span>
			<span class="token keyword">return</span> claims<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用户服务，登录操作</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>ctl <span class="token operator">*</span>userService<span class="token punctuation">)</span> <span class="token function">Login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>smodel<span class="token punctuation">.</span>Login<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> admin model<span class="token punctuation">.</span>User
	where <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;user_name&quot;</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">&quot;is_delete&quot;</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>UserIsDeletedNo<span class="token punctuation">}</span>
	err <span class="token operator">:=</span> ctl<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> where<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>admin<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> gorm<span class="token punctuation">.</span>ErrRecordNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// 检查密码</span>
	<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> gorm<span class="token punctuation">.</span>ErrRecordNotFound<span class="token punctuation">)</span> <span class="token operator">||</span> admin<span class="token punctuation">.</span>Password <span class="token operator">!=</span> encodeUtil<span class="token punctuation">.</span><span class="token function">EncryptionPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> admin<span class="token punctuation">.</span>Salt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> bizerr<span class="token punctuation">.</span>UserNamePasswordErr
	<span class="token punctuation">}</span>

	<span class="token comment">// 获取登录token</span>
	token<span class="token punctuation">,</span> expireAt<span class="token punctuation">,</span> err <span class="token operator">:=</span> Jwt<span class="token punctuation">.</span><span class="token function">GenerateAdminToken</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> admin<span class="token punctuation">.</span>UserName<span class="token punctuation">,</span> admin<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token operator">*</span>viper<span class="token punctuation">.</span><span class="token function">GetDuration</span><span class="token punctuation">(</span><span class="token string">&quot;TOKEN_EXPIRE_HOUR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithMessage</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;获取登录token失败&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>smodel<span class="token punctuation">.</span>Login<span class="token punctuation">{</span>Token<span class="token punctuation">:</span> token<span class="token punctuation">,</span> ExpireAt<span class="token punctuation">:</span> expireAt<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>参考文章：https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html</p></div><!----><!--]--></div><div class="card catalog" data-v-dd29a953 data-v-280e4acd data-v-2e70653c><!--[--><div class="catalog-header" data-v-280e4acd>目录</div><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div><div class="catalog-content" data-v-280e4acd><!--[--><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#jwt" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!--[--><!--[--><div class="catalog-item catalog-item_circle" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:0.8333333333333334;font-weight:400;" href="#_1-session认证" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!--[--><div class="catalog-item catalog-item_circle" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:0.8333333333333334;font-weight:400;" href="#_2-jwt的原理" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!--[--><div class="catalog-item catalog-item_circle" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:0.8333333333333334;font-weight:400;" href="#_3-jwt的数据结构" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!--[--><div class="catalog-item catalog-item_circle" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:0.8333333333333334;font-weight:400;" href="#_4-jwt-的使用方式" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!--[--><div class="catalog-item catalog-item_circle" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:0.8333333333333334;font-weight:400;" href="#_5-jwt的几个特点" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!--]--><!--]--><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div></div><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#go实现用户身份校验" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!--[--><!--[--><div class="catalog-item catalog-item_circle" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:0.8333333333333334;font-weight:400;" href="#_1-登录" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!--]--><!--]--><!----></div><!--]--></div><!--]--></div></div><!--]--></div><div class="footer" data-v-a231a75e data-v-21eb7198><section class="footer-section" data-v-21eb7198>©2023 Mittacy. All rights reserved</section><!--[--><section class="footer-section" data-v-21eb7198><span data-v-21eb7198>备案号: 粤ICP备2021130319号-1</span></section><section class="footer-section" data-v-21eb7198><a href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferrer" data-v-21eb7198></a></section><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-a6a5d4a7.js" defer></script>
  </body>
</html>
