<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.64">
    <title>Docker 博客后端部署过程 | Vuepress Theme Blue</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-0b99fa56.css" as="style"><link rel="stylesheet" href="/assets/style-0b99fa56.css">
    <link rel="modulepreload" href="/assets/app-a6a5d4a7.js"><link rel="modulepreload" href="/assets/index.html-fd95335e.js"><link rel="modulepreload" href="/assets/index.html-e14ec4b7.js"><link rel="prefetch" href="/assets/404.html-30afe3c5.js" as="script"><link rel="prefetch" href="/assets/index.html-87180724.js" as="script"><link rel="prefetch" href="/assets/index.html-ed0fd3d1.js" as="script"><link rel="prefetch" href="/assets/index.html-817918d0.js" as="script"><link rel="prefetch" href="/assets/index.html-ab2771d8.js" as="script"><link rel="prefetch" href="/assets/index.html-62bdddc1.js" as="script"><link rel="prefetch" href="/assets/index.html-0aaea317.js" as="script"><link rel="prefetch" href="/assets/index.html-362e5eda.js" as="script"><link rel="prefetch" href="/assets/index.html-22e9a1e5.js" as="script"><link rel="prefetch" href="/assets/index.html-03899184.js" as="script"><link rel="prefetch" href="/assets/index.html-bd04de7d.js" as="script"><link rel="prefetch" href="/assets/index.html-8432d7c2.js" as="script"><link rel="prefetch" href="/assets/index.html-f4bc7919.js" as="script"><link rel="prefetch" href="/assets/index.html-266cfb01.js" as="script"><link rel="prefetch" href="/assets/index.html-b2cc8270.js" as="script"><link rel="prefetch" href="/assets/index.html-98c00800.js" as="script"><link rel="prefetch" href="/assets/index.html-ae33ec0f.js" as="script"><link rel="prefetch" href="/assets/index.html-9f76b2fb.js" as="script"><link rel="prefetch" href="/assets/index.html-a8dc90b6.js" as="script"><link rel="prefetch" href="/assets/index.html-3d3599dc.js" as="script"><link rel="prefetch" href="/assets/index.html-23399167.js" as="script"><link rel="prefetch" href="/assets/index.html-404c3b2e.js" as="script"><link rel="prefetch" href="/assets/index.html-a9560cb8.js" as="script"><link rel="prefetch" href="/assets/index.html-0a493daa.js" as="script"><link rel="prefetch" href="/assets/index.html-cdee76d8.js" as="script"><link rel="prefetch" href="/assets/index.html-0e1d1c06.js" as="script"><link rel="prefetch" href="/assets/index.html-f692a8a6.js" as="script"><link rel="prefetch" href="/assets/index.html-b5f11fde.js" as="script"><link rel="prefetch" href="/assets/index.html-bb530bb0.js" as="script"><link rel="prefetch" href="/assets/index.html-0c076014.js" as="script"><link rel="prefetch" href="/assets/index.html-e965da56.js" as="script"><link rel="prefetch" href="/assets/index.html-d03c30ac.js" as="script"><link rel="prefetch" href="/assets/index.html-3f6e11fd.js" as="script"><link rel="prefetch" href="/assets/index.html-718a010f.js" as="script"><link rel="prefetch" href="/assets/index.html-b53b6fcb.js" as="script"><link rel="prefetch" href="/assets/index.html-023f9a25.js" as="script"><link rel="prefetch" href="/assets/index.html-52791d54.js" as="script"><link rel="prefetch" href="/assets/index.html-782e61bb.js" as="script"><link rel="prefetch" href="/assets/index.html-98c2c35b.js" as="script"><link rel="prefetch" href="/assets/index.html-fabfc81c.js" as="script"><link rel="prefetch" href="/assets/index.html-8fb78894.js" as="script"><link rel="prefetch" href="/assets/index.html-620675de.js" as="script"><link rel="prefetch" href="/assets/index.html-b7cf35a2.js" as="script"><link rel="prefetch" href="/assets/index.html-d9618c98.js" as="script"><link rel="prefetch" href="/assets/index.html-295b3ade.js" as="script"><link rel="prefetch" href="/assets/index.html-3da56c89.js" as="script"><link rel="prefetch" href="/assets/index.html-ea362abf.js" as="script"><link rel="prefetch" href="/assets/index.html-f5f5632b.js" as="script"><link rel="prefetch" href="/assets/index.html-df93660b.js" as="script"><link rel="prefetch" href="/assets/index.html-164449d6.js" as="script"><link rel="prefetch" href="/assets/index.html-4b594f0f.js" as="script"><link rel="prefetch" href="/assets/index.html-3ff531d7.js" as="script"><link rel="prefetch" href="/assets/404.html-99967f39.js" as="script"><link rel="prefetch" href="/assets/index.html-02bedc7d.js" as="script"><link rel="prefetch" href="/assets/index.html-32ba965a.js" as="script"><link rel="prefetch" href="/assets/index.html-8d2845c0.js" as="script"><link rel="prefetch" href="/assets/index.html-7e3b40a2.js" as="script"><link rel="prefetch" href="/assets/index.html-5e14943c.js" as="script"><link rel="prefetch" href="/assets/index.html-8ddd90f6.js" as="script"><link rel="prefetch" href="/assets/index.html-199bc0b0.js" as="script"><link rel="prefetch" href="/assets/index.html-f8b17ccb.js" as="script"><link rel="prefetch" href="/assets/index.html-1ff18482.js" as="script"><link rel="prefetch" href="/assets/index.html-731a621f.js" as="script"><link rel="prefetch" href="/assets/index.html-cb2cf034.js" as="script"><link rel="prefetch" href="/assets/index.html-ffdd0bf6.js" as="script"><link rel="prefetch" href="/assets/index.html-42d4917e.js" as="script"><link rel="prefetch" href="/assets/index.html-9a0a97b3.js" as="script"><link rel="prefetch" href="/assets/index.html-81eaf5de.js" as="script"><link rel="prefetch" href="/assets/index.html-ebb9ee77.js" as="script"><link rel="prefetch" href="/assets/index.html-23c0d38b.js" as="script"><link rel="prefetch" href="/assets/index.html-816f6ec1.js" as="script"><link rel="prefetch" href="/assets/index.html-e9073f0e.js" as="script"><link rel="prefetch" href="/assets/index.html-e96cc586.js" as="script"><link rel="prefetch" href="/assets/index.html-a6758ea4.js" as="script"><link rel="prefetch" href="/assets/index.html-8cc81fbf.js" as="script"><link rel="prefetch" href="/assets/index.html-d3d05473.js" as="script"><link rel="prefetch" href="/assets/index.html-6170b0bf.js" as="script"><link rel="prefetch" href="/assets/index.html-30911cd4.js" as="script"><link rel="prefetch" href="/assets/index.html-33b21e52.js" as="script"><link rel="prefetch" href="/assets/index.html-5e65c1b9.js" as="script"><link rel="prefetch" href="/assets/index.html-2a164f81.js" as="script"><link rel="prefetch" href="/assets/index.html-2147f896.js" as="script"><link rel="prefetch" href="/assets/index.html-11385ea4.js" as="script"><link rel="prefetch" href="/assets/index.html-e02a98c4.js" as="script"><link rel="prefetch" href="/assets/index.html-e7298fb0.js" as="script"><link rel="prefetch" href="/assets/index.html-ef1df29b.js" as="script"><link rel="prefetch" href="/assets/index.html-82ec9c97.js" as="script"><link rel="prefetch" href="/assets/index.html-51dc7c9c.js" as="script"><link rel="prefetch" href="/assets/index.html-f8e6c09a.js" as="script"><link rel="prefetch" href="/assets/index.html-d7237f1b.js" as="script"><link rel="prefetch" href="/assets/index.html-264956b9.js" as="script"><link rel="prefetch" href="/assets/index.html-c0aca1d1.js" as="script"><link rel="prefetch" href="/assets/index.html-77117f6a.js" as="script"><link rel="prefetch" href="/assets/index.html-ece5da38.js" as="script"><link rel="prefetch" href="/assets/index.html-00db6cca.js" as="script"><link rel="prefetch" href="/assets/index.html-14649045.js" as="script"><link rel="prefetch" href="/assets/index.html-6546a4e6.js" as="script"><link rel="prefetch" href="/assets/index.html-9b4e410e.js" as="script"><link rel="prefetch" href="/assets/index.html-9aa4d534.js" as="script"><link rel="prefetch" href="/assets/index.html-05b76199.js" as="script"><link rel="prefetch" href="/assets/index.html-66c19831.js" as="script"><link rel="prefetch" href="/assets/index.html-3caeb87d.js" as="script"><link rel="prefetch" href="/assets/index.html-9d0d9115.js" as="script"><link rel="prefetch" href="/assets/index.html-ad57ae51.js" as="script"><link rel="prefetch" href="/assets/giscus-2a044aea-497f0bd4.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><div class="nav" data-v-a231a75e data-v-ad3cbd41><div class="container" data-v-ad3cbd41><!--[--><a href="/" class="nav-action-wrapper" data-v-ad3cbd41><div class="nav-action" data-v-ad3cbd41>首页</div></a><a href="/category" class="nav-action-wrapper" data-v-ad3cbd41><div class="nav-action" data-v-ad3cbd41>分类</div></a><!--]--></div></div><div class="container" data-v-a231a75e><!--[--><div class="blog-page" data-v-dd29a953><div class="card blog" data-v-dd29a953 data-v-2e70653c><!--[--><!----><h1 class="title" data-v-dd29a953>Docker 博客后端部署过程</h1><div class="markdown-body content" data-v-dd29a953><h3 id="_1-docker容器选择" tabindex="-1"><a class="header-anchor" href="#_1-docker容器选择" aria-hidden="true">#</a> 1. Docker容器选择</h3><h4 id="_1-1-使用golang容器" tabindex="-1"><a class="header-anchor" href="#_1-1-使用golang容器" aria-hidden="true">#</a> 1.1 使用golang容器</h4><p>项目使用Go编写的api后台服务，Vue编写了前端编译成静态文件</p><p>首先Go先用交叉编译出可执行文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linux <span class="token assign-left variable">GOARCH</span><span class="token operator">=</span>amd64 go build <span class="token parameter variable">-o</span> blog main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>生成blog可执行文件，和Vue编译后的文件放一起，结构如下</p><p><img src="https://static.mittacy.com/blog/20200426004218.png" alt=""></p><p>编写Dockerfile文件内容如下</p><div class="language-docker line-numbers-mode" data-ext="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> golang</span>
<span class="token instruction"><span class="token keyword">MAINTAINER</span> mittacyChen <span class="token string">&quot;mail@mittacy.com&quot;</span></span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> <span class="token variable">$GOPATH</span>/src/blog-gin</span>

<span class="token instruction"><span class="token keyword">COPY</span> . <span class="token variable">$GOPATH</span>/src/blog-gin</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3824</span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;./blog&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>FROM golang</code></li><li><code>MAINTAINER ...</code> 标明作者和邮箱</li><li><code>WORDKDIR</code> 在容器内部工作位置</li><li><code>COPY . $GOPATH/src/blog-gin</code> 将当前目录所有文件复制到容器$GOPATH/src/blog-gin</li><li><code>EXPOSE 3824</code> 暴露容器的3824端口(因为我的项目监听了3824端口)</li><li><code>ENTRYPOINT [&quot;./blog&quot;]</code> 建立容器的时候运行的命令</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> build <span class="token parameter variable">-t</span> mittacy/blog <span class="token builtin class-name">.</span>
<span class="token comment"># 查看所有images</span>
$ <span class="token function">docker</span> images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
mittacy/blog        latest              4b79e2595b7e        <span class="token number">1</span> hours ago         828MB
redis               latest              f0453552d7f2        <span class="token number">6</span> weeks ago         <span class="token number">98</span>.2MB
mysql               latest              9b51d9275906        <span class="token number">7</span> weeks ago         547MB
<span class="token comment"># 查看已运行的容器</span>
$ <span class="token function">docker</span> <span class="token function">ps</span>
<span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES
b1f9d26dc011        mysql               <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">22</span> minutes ago      Up <span class="token number">22</span> minutes       <span class="token number">0.0</span>.0.0:3306-<span class="token operator">&gt;</span><span class="token number">3306</span>/tcp, <span class="token number">33060</span>/tcp   mysql
fabfe12c2b29        redis               <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">8</span> hours ago         Up About an hour    <span class="token number">0.0</span>.0.0:6379-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp              redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>建立项目容器并运行在后台：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> blog <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">3824</span>:3824 mittacy/blog
d3324c27e0e244d5e2732c800407f8799b03152021e5ec653568d3bbe68aad80
$ <span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES
d3324c27e0e2        mittacy/blog      <span class="token string">&quot;./blog&quot;</span>                 <span class="token number">12</span> minutes ago      Up <span class="token number">12</span> minutes       <span class="token number">0.0</span>.0.0:3824-<span class="token operator">&gt;</span><span class="token number">3824</span>/tcp              blog
b1f9d26dc011        mysql               <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">22</span> minutes ago      Up <span class="token number">22</span> minutes       <span class="token number">0.0</span>.0.0:3306-<span class="token operator">&gt;</span><span class="token number">3306</span>/tcp, <span class="token number">33060</span>/tcp   mysql
fabfe12c2b29        redis               <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">8</span> hours ago         Up About an hour    <span class="token number">0.0</span>.0.0:6379-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp              redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打开浏览器访问<code> 0.0.0.0:3824</code></p><p>成功访问，如果<code>docker ps</code>发现项目不在运行，说明出错，可以使用<code>docker logs blog</code>查看错误提示</p><h4 id="_1-2-使用scratch容器" tabindex="-1"><a class="header-anchor" href="#_1-2-使用scratch容器" aria-hidden="true">#</a> 1.2 使用scratch容器</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
mittacy/blog        latest              4b79e2595b7e        <span class="token number">7</span> hours ago         828MB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到image很大，其实，我们是在本地交叉编译出了blog可执行文件，完全不需要golang的环境，只需要go可执行文件的环境，所以可以使用scratch</p><p>修改Dockerfile文件为</p><div class="language-docker line-numbers-mode" data-ext="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">MAINTAINER</span> mittacyChen <span class="token string">&quot;mail@mittacy.com&quot;</span></span>

<span class="token instruction"><span class="token keyword">COPY</span> . .</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3824</span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;./blog&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>建立镜像、容器并运行</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> build <span class="token parameter variable">-t</span> mittacy/blog:2 <span class="token builtin class-name">.</span>
$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> blog <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">3824</span>:3824 mittacy/blog:2
20fd62fd6fe765b56a6f5e375bde94042d1c79f1c77c40b738cd87532b4fbbe4
$ <span class="token function">docker</span> <span class="token function">ps</span>
<span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                               NAMES
20fd62fd6fe7        mittacy/blog:2      <span class="token string">&quot;./blog&quot;</span>                 About a minute ago   Up <span class="token number">10</span> seconds       <span class="token number">0.0</span>.0.0:3824-<span class="token operator">&gt;</span><span class="token number">3824</span>/tcp              blog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样打开浏览器运行<code>0.0.0.0:3824</code></p><p>查看两个image大小差别</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> images
<span class="token function">docker</span> images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
mittacy/blog        <span class="token number">2</span>                   61898d44156a        <span class="token number">5</span> minutes ago       <span class="token number">18</span>.6MB
mittacy/blog        latest              4b79e2595b7e        <span class="token number">8</span> hours ago         828MB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-自动构建" tabindex="-1"><a class="header-anchor" href="#_2-自动构建" aria-hidden="true">#</a> 2. 自动构建</h3><p>image构建好了，我们需要在服务端或者这个image，就需要上传到Docker Hub上，可以使用直接上传，也可以通过Github获取自动构建，我使用的是Github自动构建</p><p>将项目添加到github中作为单独的仓库，也就是这个文件夹</p><p><img src="https://static.mittacy.com/blog/20200426004218.png" alt=""></p><p>Docker hub链接github账户，添加该仓库，构建images，以后每次修改github仓库，Docker hub都会自动重新构建该image</p><p>至此，所有安装了Docker服务的环境都能获取该image项目</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> pull mittacy/blog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_3-链接数据库" tabindex="-1"><a class="header-anchor" href="#_3-链接数据库" aria-hidden="true">#</a> 3. 链接数据库</h3><p>我的博客使用到了mysql、redis，所以需要提前部署好数据库</p><h4 id="_3-1-使用docker安装数据库容器" tabindex="-1"><a class="header-anchor" href="#_3-1-使用docker安装数据库容器" aria-hidden="true">#</a> 3.1 使用Docker安装数据库容器</h4><p><a href="https://blog.mittacy.com/article/53" target="_blank" rel="noopener noreferrer">Docker安装mysql&amp;redis</a></p><p>如果使用这种建容器方式，会出现一个问题：项目内部连接数据库的时候无法使用127.0.0.1连接数据库</p><p><strong>docker是一个虚拟环境,127.0.0.1和localhost指的是虚拟环境内部,而不是外部宿主机,所以如果写127.0.0.1是无法访问的</strong></p><p>解决上述问题</p><ul><li><p>对于mac和windows,可以使用host.docker.internal替换127.0.0.1,如 mongodb://host.docker.internal:27017</p></li><li><p>对于Linux可以采用如下方案(后续应该也可以用上面的方案,但是当前docker还没有修改此问题):</p><p>创建一个桥接网络</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># localNet是网络名字,可自行修改; 192.168.0.0这个子网,也可以自行定义</span>
<span class="token comment"># 默认按照上面的命令,执行后将可以通过192.168.0.1访问宿主机</span>
$ <span class="token function">docker</span> network create <span class="token parameter variable">-d</span> bridge <span class="token parameter variable">--subnet</span> <span class="token number">192.168</span>.0.0/24 <span class="token parameter variable">--gateway</span> <span class="token number">192.168</span>.0.1 localNet
<span class="token comment"># 使用192.168.0.1替换127.0.0.1,如192.168.0.1:3306</span>
<span class="token comment"># 运行blog项目image, 3824是项目监听端口</span>
$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> blog <span class="token parameter variable">--link</span> mysql:mysql <span class="token parameter variable">--link</span> redis:redis <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">3824</span>:3824 mittacy/blog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_3-2-直接安装数据库到部署系统" tabindex="-1"><a class="header-anchor" href="#_3-2-直接安装数据库到部署系统" aria-hidden="true">#</a> 3.2 直接安装数据库到部署系统</h4><p>这种情况需要使用docker host网络模式，该模式将禁用docker容器的网络隔离</p><p>建容器时加入<code>--net=host</code>即可</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> blog <span class="token parameter variable">--net</span><span class="token operator">=</span>host <span class="token parameter variable">-d</span> mittacy/blog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_4-奔溃自动重启" tabindex="-1"><a class="header-anchor" href="#_4-奔溃自动重启" aria-hidden="true">#</a> 4. 奔溃自动重启</h3><p>如果由于某种错误而导致容器停止运行，还可以通过--restart 标志，让Docker自动重新启动该容器。--restart会检查容器的退出代码，并据此来决定是否要重启容器，默认是Docker不会重启容器</p><p>如果想要重启，有以下参数：</p><ul><li><p>always：无论退出代码是什么，都会重启该容器</p></li><li><p>unless-stopped：在容器退出时总是重启容器，但是不考虑在Docker守护进程启动时就已经停止了的容器</p></li><li><p>on-failure：只有当容器的退出代码为非0值的时候，才会自动重启</p><p>on-failure还接收一个可选的重启次数参数</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> blog <span class="token parameter variable">--restart</span><span class="token operator">=</span>on-failure <span class="token parameter variable">--net</span><span class="token operator">=</span>host <span class="token parameter variable">-d</span> mittacy/blog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_5-nginx监听转发" tabindex="-1"><a class="header-anchor" href="#_5-nginx监听转发" aria-hidden="true">#</a> 5. Nginx监听转发</h3><p>在<code>/etc/nginx/conf.d/</code>下新建一个文件夹名为：网址.conf,</p><p>比如我的博客: <code>/etc/nginx/conf.d/blog.mittacy.com.conf</code></p><ul><li>项目运行端口为5201</li></ul><p>blog.mittacy.com.conf 配置文件如下：</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">server_name</span> blog.mittacy.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>		<span class="token comment"># 监听80端口</span>

  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:3824</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span>:3824</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-使用https-http2" tabindex="-1"><a class="header-anchor" href="#_6-使用https-http2" aria-hidden="true">#</a> 6. 使用https &amp; http2</h3><h4 id="_6-1-安装let-s-encrypt" tabindex="-1"><a class="header-anchor" href="#_6-1-安装let-s-encrypt" aria-hidden="true">#</a> 6.1 安装Let’s Encrypt</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 安装</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> software-properties-common
$ <span class="token function">sudo</span> add-apt-repository <span class="token parameter variable">-y</span> ppa:certbot/certbot
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-certbot-apache
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> letsencrypt
<span class="token comment"># 生成证书</span>
$ letsencrypt certonly --agree-tos <span class="token parameter variable">--email</span> mail@mittacy.com <span class="token parameter variable">-d</span> blog.mittacy.com
<span class="token comment"># 检查/etc/letsencrypt/live/www.xxxxx.com</span>
$ <span class="token builtin class-name">cd</span> /etc/letsencrypt/live/blog.mittacy.com
$ <span class="token function">ls</span>
cert.pem  chain.pem  fullchain.pem  privkey.pem  README
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改Nginx配置</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> /etc/nginx/conf.d/
$ <span class="token function">vim</span> blog.mittacy.com.conf
<span class="token comment">## 内容如下</span>
server <span class="token punctuation">{</span>
  server_name blog.mittacy.com<span class="token punctuation">;</span>
  listen <span class="token number">443</span> ssl http2<span class="token punctuation">;</span>
  ssl_certificate /etc/letsencrypt/live/blog.mittacy.com/fullchain.pem<span class="token punctuation">;</span>
  ssl_certificate_key /etc/letsencrypt/live/blog.mittacy.com/privkey.pem<span class="token punctuation">;</span>
  ssl_session_timeout 1d<span class="token punctuation">;</span>
  ssl_session_cache shared:SSL:50m<span class="token punctuation">;</span>
  ssl_session_tickets off<span class="token punctuation">;</span>

  location / <span class="token punctuation">{</span>
    proxy_pass http://localhost:3824<span class="token punctuation">;</span>
    proxy_set_header Host <span class="token variable">$host</span>:3824<span class="token punctuation">;</span>
    proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name mittacy.com blog.mittacy.com<span class="token punctuation">;</span>
    <span class="token builtin class-name">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，以下部分是为了让http重定向到https</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> mittacy.com blog.mittacy.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!--]--></div><div class="card catalog" data-v-dd29a953 data-v-280e4acd data-v-2e70653c><!--[--><div class="catalog-header" data-v-280e4acd>目录</div><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div><div class="catalog-content" data-v-280e4acd><!--[--><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#_1-docker容器选择" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div></div><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#_2-自动构建" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div></div><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#_3-链接数据库" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div></div><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#_4-奔溃自动重启" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div></div><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#_5-nginx监听转发" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><div style="margin-top:5px;margin-bottom:5px;" class="line" data-v-280e4acd data-v-901d8423></div></div><div class="catalog-item-wrapper" data-v-280e4acd><!--[--><div class="catalog-item" data-v-3d6f5fbb><a class="catalog-item-link" style="opacity:1;font-weight:600;" href="#_6-使用https-http2" data-v-3d6f5fbb><div class="vue-ellipsis" data-v-3d6f5fbb><div class="vue-ellipsis-js"><span class="vue-ellipsis-js-content"></span><span class="vue-ellipsis-js-ellipsis"><!--[--><!--[-->...<!--]--><!--[--><!--]--><!--]--></span></div></div></a></div><!----><!--]--><!----></div><!--]--></div><!--]--></div></div><!--]--></div><div class="footer" data-v-a231a75e data-v-21eb7198><section class="footer-section" data-v-21eb7198>©2023 Mittacy. All rights reserved</section><!--[--><section class="footer-section" data-v-21eb7198><span data-v-21eb7198>备案号: 粤ICP备2021130319号-1</span></section><section class="footer-section" data-v-21eb7198><a href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferrer" data-v-21eb7198></a></section><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-a6a5d4a7.js" defer></script>
  </body>
</html>
